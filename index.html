<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Riddles in the Dark</title>
        <meta name="description" content="Can you find and solve the riddles?">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Knewave&display=swap" rel="stylesheet">
        <link rel="shortcut icon" href="favicon.ico?" type="image/x-icon">
        <link rel="icon" type="image/x-icon" href="favicon.ico?">
    </head>
    <body style="user-select:none">
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
        <h1 
            class="pt-4 pb-2 text-2xl text-center md:text-3xl" 
            style="font-family: 'Knewave', cursive;"
        >
            riddles in the dark
        </h1>
        <div 
            class="relative mx-auto mt-4" 
            style="width: 640px; height: 425px; background-image: url('images/room.png'); background-size: cover;"
        >
            <p 
                id="current-question"
                class="absolute w-full pb-1 pl-2 text-xs text-white select-none"
            >
                What word starts with <span class="italic">'e'</span> and ends with <span class="italic">'e'</span>, but usually has only one letter in it? 
            </p>
            <canvas 
                id="room" 
                class="absolute top-0 left-0 mx-auto" 
                width="640" 
                height="425"
                style="max-width: 640px; cursor:  crosshair; cursor: url('images/flashlight3.png') 53 53, crosshair;"
            ></canvas>
        </div>
        <div class="flex items-center justify-center">
            <form id="answer-form" class="p-8">
                <label for="riddle-answer" class="pr-4 font-medium select-none" style="font-family: 'Knewave', cursive;">what's the answer?</label>
                <input type="text" class="p-1 border" name="riddle-answer" id="riddle-answer" />
                <button
                    id="submit" 
                    type="submit" 
                    class="px-2 py-1 font-medium text-yellow-300 bg-gray-500 rounded cursor-not-allowed"
                    disabled
                >
                    submit
                </button>
            </form>
        </div>
        <p id="response" class="font-medium text-center select-none" style="font-family: 'Knewave', cursive;"></p>
        <div class="flex items-center justify-center mt-4">
            <button
                id="new-riddle" 
                type="button" 
                class="px-2 py-1 font-medium text-yellow-300 bg-black rounded hover:bg-gray-800 focus:bg-gray-600"
            >
                get another riddle
            </button>
            <button
                id="give-up" 
                type="button" 
                class="px-2 py-1 ml-2 font-medium text-yellow-300 bg-black rounded hover:bg-gray-800 focus:bg-gray-600"
            >
                give up?
            </button>
        </div>
        <p class="mt-4 font-medium text-center">
            <span class="font-medium" style="font-family: 'Knewave', cursive;">score:</span>
            <span id="points" class="font-bold">0</span>
            <span class="font-medium" style="font-family: 'Knewave', cursive;">/</span>
            <span id="potential-points" class="font-bold">1</span>
        </p>
        <script src="riddles.js"></script>
        <script type='text/javascript'>
            const verticalPositions = [
                'top-1', 'bottom-4', 'bottom-1', 'bottom-60', 'bottom-44', 'top-16', 'top-24', 'bottom-16', 'bottom-48'
            ]
            const horizontalPositions = [ 'text-center', 'text-left', 'text-right']

            const questionEl = document.getElementById('current-question')
            const riddleAnswerForm = document.getElementById('answer-form')
            const answerInput = document.getElementById('riddle-answer')
            const responseEl = document.getElementById('response')

            var room = document.getElementById("room"),
            roomCanvas = room.getContext('2d'),
            brushRadius = 300,
            img = new Image()
            img.src = 'images/cover.gif'
            img.onload = function() {  
                roomCanvas.drawImage(img, 0, 0, room.width, room.height)
                roomCanvas.font = '16px Arial'
                roomCanvas.fillStyle = 'yellow'
                roomCanvas.fillText('look around for the riddle', 10, 50)
            }

            // Image for drawing flash-light area
            const flashArea = new Image()
            flashArea.src = 'images/flash-area.png'

            // Read the randomized riddle index array from localStorage.
            let randomizedRiddles = JSON.parse(window.localStorage.getItem("riddles_in_the_dark")) || []
            if (randomizedRiddles.length === 0) {
                // This is either the first time we visit this page or we are out of riddles, so we must create a new randomized storage
                randomizedRiddles = getRandomIndexList()
            }
            // Set the current riddle from the first index in the randomized array
            const currentRiddle = riddles[randomizedRiddles[0]]
            // Remove the current riddle index 
            randomizedRiddles.splice(0, 1)
            // Save new array to localStorage for next time
            window.localStorage.setItem("riddles_in_the_dark", JSON.stringify(randomizedRiddles))

            // Get current score and display it
            const pointsEl = document.getElementById('points')
            const potentialPointsEl = document.getElementById('potential-points')
            pointsEl.textContent = window.localStorage.getItem('points') ?? 0
            potentialPointsEl.textContent = window.localStorage.getItem('potential_points') ?? 1

            // Grab elements needed for displaying riddle and add the riddle's question
            const theRandomVerticalIndex = Math.floor(Math.random() * verticalPositions.length)
            const theRandomHorizontalIndex = Math.floor(Math.random() * horizontalPositions.length)
            
            const submitButton = document.getElementById('submit')
            const newRiddleButton = document.getElementById('new-riddle')
            const giveUpButton = document.getElementById('give-up')

            questionEl.textContent = currentRiddle.question
            questionEl.classList.add(verticalPositions[theRandomVerticalIndex], horizontalPositions[theRandomHorizontalIndex]);
            
            riddleAnswerForm.addEventListener('submit', (e) => {
                e.preventDefault()
                if (answerInput.value.trim().toLowerCase() === currentRiddle.answer) {
                    responseEl.classList.remove('text-red-500')
                    responseEl.classList.add('text-black', 'pt-4')
                    responseEl.textContent = `congratulations, smarty pants! ${currentRiddle.answer} is correct.`
                    giveUpButton.classList.add('hidden')
                    riddleAnswerForm.classList.add('hidden')
                    const newPoints = parseInt(pointsEl.textContent) + 1
                    pointsEl.textContent = newPoints
                    window.localStorage.setItem('points', newPoints)

                } else {
                    responseEl.classList.remove('text-black', 'pt-4')
                    responseEl.classList.add('text-red-500')
                    responseEl.textContent = 'sorry, not what i was looking for. try again.'
                }
            })

            answerInput.addEventListener('input', () => {
                if (answerInput.value.length > 0) {
                    submitButton.disabled = false
                    submitButton.classList.remove('bg-gray-500', 'cursor-not-allowed')
                    submitButton.classList.add('bg-black', 'hover:bg-gray-800', 'focus:bg-gray-600')
                } else {
                    submitButton.classList.remove('bg-black', 'hover:bg-gray-800', 'focus:bg-gray-600')
                    submitButton.classList.add('bg-gray-500', 'cursor-not-allowed')
                    submitButton.disabled = true
                }
            })

            newRiddleButton.addEventListener('click', () => {
                window.localStorage.setItem('potential_points', parseInt(potentialPointsEl.textContent) + 1)
                window.location.reload()
            })

            const vowels = ['a', 'e', 'i', 'o', 'u']
            giveUpButton.addEventListener('click', () => {
                giveUpButton.classList.add('hidden')
                riddleAnswerForm.classList.add('hidden')
                responseEl.classList.add('pt-4')
                responseEl.textContent = `ok, better luck next time...`
                setTimeout( () => {
                    responseEl.textContent = `the answer you seek is a${vowels.includes(currentRiddle.answer[0].toLowerCase()) ? 'n': ''} ${currentRiddle.answer}.`
                }, 1000)
            })
            
            room.addEventListener("mousemove", function(e) {
                var brushPos = getBrushPos(e.clientX, e.clientY);
                var leftBut = detectLeftButton(e);
                if (leftBut == 1) {
                    drawDot(brushPos.x, brushPos.y);
                }
            }, false);
            room.addEventListener("touchmove", function(e) {
                e.preventDefault();
                var touch = e.targetTouches[0];
                if (touch) {
                    var brushPos = getBrushPos(touch.pageX, touch.pageY);
                    drawDot(brushPos.x, brushPos.y);
                }
            }, false);
            function detectLeftButton(event) {
                if ('buttons' in event) {
                    return event.buttons === 1;
                } else if ('which' in event) {
                    return event.which === 1;
                } else {
                    return event.button === 1;
                }
            }
            function getBrushPos(xRef, yRef) {
                var roomRect = room.getBoundingClientRect();
                return {
                x: Math.floor((xRef - roomRect.left) / (roomRect.right - roomRect.left) * room.width),
                y: Math.floor((yRef - roomRect.top) / (roomRect.bottom - roomRect.top) * room.height)
                };
            }
            function drawDot(mouseX,mouseY) {
                // Skip - if you want to reveal image gradually
                roomCanvas.globalCompositeOperation = "source-over";
                roomCanvas.drawImage(img, 0, 0, room.width, room.height)
                roomCanvas.font = '16px Arial'
                roomCanvas.fillStyle = 'yellow'
                roomCanvas.fillText('look around for the riddle', 10, 50)
                // End skip
                roomCanvas.globalCompositeOperation = "destination-out"
                roomCanvas.drawImage(flashArea, mouseX - 220, mouseY - 220, brushRadius, brushRadius)
            }
            // Function for creating a list of randomized indexes of riddles
            function getRandomIndexList() {
                let allRiddles = riddles.map((_, idx) => idx)
                let n = allRiddles.length
                let result = []
                for (var i = 0; i < n; i++) {
                    let randomValue = Math.floor(Math.random() * allRiddles.length) // Pick out a random index from all riddles array
                    result.push(allRiddles[randomValue])
                    allRiddles.splice(randomValue, 1) // Remove the picked index from list to not be used again
                }
                return result
            }
        </script>
    </body>
</html>